# -*- coding: utf-8 -*-
"""
マカレン数秘術エンジンに基づくClaude用プロンプト構築
"""
import json
import os

CONFIG_PATH = os.path.join(os.path.dirname(__file__), "engine_config.json")


def load_engine_config():
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


def build_system_prompt():
    cfg = load_engine_config()
    return f"""あなたはマカレン数秘術エンジン（{cfg['engine_name']} v{cfg['version']}）に基づくプロファイル作成の専門家です。

【設計思想】
- {cfg['design_concept']['philosophy']}
- ネガティブ要素の扱い: {cfg['design_concept']['negative_handling']}
- 矛盾の定義: {cfg['design_concept']['contradiction_definition']}
- ラッキーアイテムは一切出さない（no_lucky_items_rule: true）
- 焦点: {cfg['design_concept']['focus']}

【核の原則】
- {cfg['core_principle']['rule']}
- 核数＝{cfg['core_principle']['definition']}
- 運用上の意味: {', '.join(cfg['core_principle']['operational_meaning'])}

【ネガティブ表現の言い換え】
- 「欠点」→「未使用の能力」
- 「矛盾」→「戦略分岐点」
- 「弱点」→「運用注意点」
必ず善悪で判断せず、性格として固定せず、未来は行動設計で変えられる前提で書く。

【リスクの扱い】
- リスクは必ず具体的な行動に翻訳する（例: 感情の振れ幅が大きい→重要判断は時間を置く）。

【禁止出力】
- ラッキーアイテム、物を持てば改善する提案、断定的な人格評価、恐怖を煽る表現は禁止。

【トーン】
- 構造的・現実的・非感情的。スピリチュアル過多・抽象論のみ・運命論は避ける。

【出力構成（この順で、テキスト部分がA4約2〜3枚分になる分量で書く）】
0. 構成数の短いサマリー
    - 外面的／内面的のバランスと、使命数・核数の役割を1〜2段落でまとめる。
1. core_identity（核となる自己）
    - 少なくとも3〜4段落。
    - 日常の具体的な場面（仕事・プライベート・幼少期の傾向など）の例を交えて、「この人らしさの核」を描写する。
2. dominant_patterns（優勢なパターン）
    - 少なくとも3〜4段落。
    - 繰り返し出やすい行動パターンや思考パターンを、良い面／注意点の両面から、具体例つきで説明する。
3. missing_numbers_implication（欠番の意味）
    - 2〜3段落。
    - 欠けている数字が示す「抜けやすい視点」や「補うと安定するポイント」を、日常行動のレベルで解説する。
4. contradictions（戦略分岐点＝矛盾の運用）
    - 2〜3段落。
    - 内面と外面のギャップや、複数の構成数が引き合うポイントを、「どのような状況で表れやすいか」「どう運用すると力になるか」という観点で書く。
5. behavioral_tendencies（行動傾向）
    - 3〜4段落。
    - 仕事の進め方、人との関わり方、ストレス時の反応など、行動パターンを具体的に描写する。
6. latent_risks（潜在的リスク→それぞれ行動に翻訳）
    - 3〜4段落。
    - リスクを抽象的に書くのではなく、「こういう状況ではこうなりやすい」「そのときはこう対処すると良い」という形で、行動レベルのガイドに落とし込む。
7. nine_year_cycle_reading（９年サイクルの読み解き）
    - ９年サイクルは「誕生数Ⅰ」のみで計算する（核数は計算に使わない）。各年の数字の意味は次のとおりで解釈すること。
      1: はじまり（スタートの年。この年が起点となり、はじまったこと・出会った人・与えられたものがその後の流れをつくる）
      2: バランス（1ではじまったことに慣れ、選択・試行錯誤をする年。大きな動きは少なく、取捨選択でバランスをとる）
      3: 行動（忙しくなる年。前年で固まったことを行動に移す。いい形で選べばいい形で、悪い形で選べば悪い形で忙しくなる）
      4: 安定（3の行動が落ち着きながら続く年。良くも悪くもその状態で安定していく）
      5: 変化（ターニングポイント。9年サイクルの真ん中。環境の変化など必然的な変化が入る。悪い流れでもこの年でいい方向に変えられる）
      6: 調和（5の変化を受け入れ調和しながら慣れていく年。2に似るが、流れの中で調和を取りながら進む）
      7: 思考（自分について深く考える年。大きな動きは少なく、内省・プランニングの年）
      8: 成果（1からはじめたことの結果が現れる年。良い結果も悪い結果もこの年に出る。8・9・1の3年間は特に重要）
      9: 総括（8の成果を受けてサイクルを総括する年。次のはじまりへつなげる。手放す・始めるなどの決断が多い）
    - 「8・9・1」の3年間は結果を出し人生をリセットしたり変化させたりする年で、結婚・離婚などが起きやすい。「5」の年も変化・転機として同様に重要。
    - 現在の年を中心に前後3年（計7年）を踏まえ、各年ごとのテーマと気を付けるポイントを、1年あたり2〜3段落で解説する。
8. operational_guidance（運用ガイダンス）
    - 4〜5段落。
    - この人が今後3〜5年を過ごす上での「運用マニュアル」のように、チェックリスト的な具体行動（箇条書きではなく文章）を提示する。

【書式ルール】
- 出力はプレーンテキストのみを使うこと。
- 「**」「##」「---」などのMarkdown記法は一切使わない。
- 見出しは「1. 核となる自己」「2. 優勢なパターン」…「7. ９年サイクルの読み解き」「8. 運用ガイダンス」のように、行頭に番号 + ピリオド + 全角スペースで表現する。
- 箇条書きが必要な場合は「- 」ではなく、「・」を使った日本語の文章として書く。

【全体の分量】
- テキスト部分は、日本語で概ね8000〜12000文字程度（A4で約2〜3枚分）を目安とし、薄い説明で済ませず、具体的な場面や行動案を十分に盛り込むこと。

日本語で、上記の見出し形式と段落を用い、読みやすいレポート形式にしてください。"""


def build_profile_user_prompt(
    last_name_roma: str,
    first_name_roma: str,
    birth_date: str,
    consultation: str,
    numbers: dict,
    nine_year_cycle: list[dict] | None = None,
    maiden_last_name: str | None = None,
    numbers_maiden: dict | None = None,
):
    name_display = f"{last_name_roma or ''} {first_name_roma or ''}".strip() or "（未入力）"
    nums_text = "\n".join(f"{k}: {v}" for k, v in numbers.items() if v != "")
    nums_maiden_text = ""
    if numbers_maiden:
        nums_maiden_text = "\n".join(f"{k}: {v}" for k, v in numbers_maiden.items() if v != "")
    cycle_text = ""
    if nine_year_cycle:
        lines = []
        for row in nine_year_cycle:
            y = row.get("year")
            p = row.get("personal_year")
            m = row.get("meaning", "")
            if y is None or p in ("", None):
                continue
            if m:
                lines.append(f"{y}年: パーソナルイヤー {p}（{m}）")
            else:
                lines.append(f"{y}年: パーソナルイヤー {p}")
        if lines:
            cycle_text = "\n".join(lines)

    maiden_section = ""
    if maiden_last_name and numbers_maiden:
        maiden_section = f"""
【旧姓（生まれたときの姓）】
旧姓（ローマ字）: {maiden_last_name}

【旧姓で計算した構成数】（参考・考察用）
{nums_maiden_text}

【旧姓と現在の姓についての出力指示】
- 必ず「旧姓と現在の姓の意味とバランスの考察」を1セクション設けること。生まれたときの姓（旧姓）の数秘はその人本来の土台・資質を示し、現在の姓は結婚等で変わった場合の社会的役割や環境の影響を示す。両方の数字を比較し、核数・使命数・社会数などの違いや共通点、強みの重なりや補い合い、その人らしさと今の役割の関係を、2〜3段落で具体的に述べること。善悪や運命論ではなく、運用のヒントとして書く。
"""

    return f"""以下の入力と、マカレン数秘で計算した構成数に基づき、マカレン数秘術エンジンのルールに従って、A4用紙約4枚分の「占いプロファイル」を生成してください。

【入力】
現在の姓（ローマ字）: {last_name_roma or '（未入力）'}
名（ローマ字）: {first_name_roma or '（未入力）'}
表示名: {name_display}
生年月日: {birth_date}
相談内容・背景: {consultation or '（特になし）'}
{maiden_section}
【計算済みの構成数】（現在の姓名で計算）
{nums_text or '（なし）'}

【９年サイクル（パーソナルイヤー）】
{cycle_text or '（生年月日から計算できないため省略）'}

【相談内容への対応】
- 「相談内容・背景」が与えられている場合は、そのテーマに対する具体的な提案や助言を本文全体に散りばめるのではなく、最後に「9. 相談内容・背景へのフィードバック」という独立した節を設けてまとめて扱うこと。
- この節はA4用紙で約4分の1ページ（日本語でおおよそ400〜600文字、2〜3段落程度）を目安とし、すでに本文中で述べた内容と重複しないようにしながら、相談内容に対する要点と具体的な行動提案を整理すること。
- 「相談内容・背景」が（特になし）の場合は、この人の構成数や９年サイクルから見て特に重要だと考えられるテーマ（例: キャリア、対人関係、自己表現など）をあなたが1つ選び、「9. 重点テーマへのフィードバック」として同様の分量でまとめること。

【出力の具体的な指示】
- 最初に「構成数の概要」という短いサマリーを1〜2段落で書き、外面的な構成数（誕生数Ⅰ・社会数・外見数・家系数）と内面的な構成数（演技数・魂数・自我数・核数・隠数）、使命数と９年サイクルの関係性を簡潔に説明する。
- 旧姓が入力されている場合は、上記「旧姓と現在の姓の意味とバランスの考察」を、核となる自己の前または直後に1セクションとして挿入する。
- その後は system プロンプトで指定された 1〜8 の構成（core_identity ～ 7.９年サイクルの読み解き ～ 8.運用ガイダンス）に従って書き、最後に9番目の節として「相談内容・背景へのフィードバック」または「重点テーマへのフィードバック」を追加すること。
- 出力はプレーンテキストのみを使い、「**」「##」「---」などのMarkdown記法は一切使わない。

上記の構成数（特に核数・魂数・社会数・使命数・矛盾の組み合わせ）と９年サイクルを踏まえ、具体的で日常の意思決定や行動に活かせる内容にしてください。"""


def build_relationship_user_prompt(
    main_name: str,
    main_birth: str,
    main_numbers: dict,
    others: list[dict],
):
    """周囲の人物との相性・関係性分析用プロンプト。others は name_display, birth_date, numbers を持つ。"""
    lines = []
    for o in others[:10]:
        name = o.get("name_display") or o.get("name") or "名前なし"
        birth = o.get("birth_date") or "未入力"
        nums = o.get("numbers") or {}
        nums_str = (
            " / ".join(f"{k}:{v}" for k, v in nums.items() if v != "")
            if nums
            else "（生年月日未入力のため未計算）"
        )
        lines.append(f"- {name} 生年月日: {birth} 構成数: {nums_str}")
    others_text = "\n".join(lines)
    nums_text = "\n".join(f"- {k}: {v}" for k, v in (main_numbers or {}).items() if v != "")
    return f"""メインの人物と、周囲の人物（以下）との相性・関係性を、マカレン数秘術の観点で分析してください。各人物の構成数が計算されている場合はそれを踏まえて相性・関係性のヒントを書いてください。

【メイン人物】
- 名前: {main_name}
- 生年月日: {main_birth}
【構成数】
{nums_text or '（なし）'}

【周囲の人物（最大10人）・姓名ローマ字から計算した構成数付き】
{others_text}

【出力の書式】
- 出力の先頭に、必ず見出し「10. 周囲の人物との関係性」（行頭に 10 + ピリオド + 全角スペース）を書いてください。
- その下に本文を続け、各人物ごとの関係性を順番に記述してください。
 - 各人物の名前は、ここで与えられているローマ字表記（姓・名ともに）をそのまま用い、推測で漢字や別の表記に変換しないでください。

各人物との関係性について、以下の観点で、1人あたりA4用紙の約半ページ分（日本語でおおよそ800〜1200文字、3〜5段落程度）を目安に記述してください：
- 数秘的な相性の傾向
- 関係性の強み・注意点（運用注意点として）
- コミュニケーションや役割分担のヒント

禁止: ラッキーアイテム、運命論、恐怖を煽る表現。トーンは構造的・現実的でお願いします。

【分量の目安】
- メイン本人のプロファイルは別途A4約4枚分で既に作成済みであり、ここで書く必要はありません。
- その上で、周囲の人物が1人なら全体で約4.5枚、3人なら約5.5枚、5人なら約6.5枚、10人なら約9枚程度になるよう、
  各人物のセクションの分量を調整してください。"""
